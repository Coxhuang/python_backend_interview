[TOC]

# Redis 淘汰删除策略


## #1 六种淘汰Key策略

> Redis中通过==maxmemory==参数来设定内存的使用上限，当Redis使用内存达到设定的最大值的时候，会根据配置文件中的策略选取要删除的key来删除，从而给新的键值留出空间

配置文件中maxmemory-policy可以设置删除redis键

规则名称 | 规则说明
---|---
noeviction (默认) | 不删除键，只返回错误
volatile-lru | 在设置了过期时间的键空间中，移除最近最少使用的key
allkeys-lru | 在所有的key中,移除最近最少使用的key
volatile-random | 在设置了过期时间的键空间中，随机移除一个key
allkeys-random | 在所有的key中,随机删除一个键
volatile-ttl | 在设置了过期时间的键空间中，移除将要过期的key

LRU算法，least RecentlyUsed，最近最少使用算法。也就是说默认删除最近最少使用的键。

但是一定要注意一点！redis中并不会准确的删除所有键中最近最少使用的键，而是随机抽取3个键，删除这三个键中最近最少使用的键。 那么3这个数字也是可以设置的，对应位置是配置文件中的maxmeory-samples.


## #2 三种删除过期键策略

> 前面我们知道需要淘汰掉哪些过期Key，但是我们应该怎么去淘汰这些过期key呢？有3种删除的操作策略：

### #2.1 定时删除

在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作；

定时删除操作对于内存来说是友好的，内存不需要操作，而是通过使用定时器，可以保证尽快的将过期键删除，但是对于CPU来说不是友好的，如果过期键比较多的话，起的定时器也会比较多，删除的这个操作会占用到CPU的资源；

### #2.2 惰性删除

放任键过期不管，但是每次从键空间中获取键时，都检查取得的键的过期时间，如果过期的话，删除即可；

惰性操作对于CPU来说是友好的，过期键只有在程序读取时判断是否过期才删除掉，而且也只会删除这一个过期键，但是对于内存来说是不友好的，如果多个键都已经过期了，而这些键又恰好没有被访问，那么这部分的内存就都不会被释放出来；


### #2.3 定期删除

每隔一段时间，程序就对数据库进行一次检查，删除掉过期键；

定期删除是上面两种方案的折中方案，每隔一段时间来删除过期键，并通过限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响，除此之外，还有效的减少内存的浪费；但是该策略的难点在于间隔时长，这个需要根据自身业务情况来进行设置；

> 目前，Redis采用的是惰性删除+定期删除的方案；






